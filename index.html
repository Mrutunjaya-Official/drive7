<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notes Enhanced View</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
:root {
  --white: #fff;
  --black: #000;
  --gray-light: #f5f5f7;
  --gray-medium: #a4a4a4;
  --gray-dark: #232323;
  --blue: #007aff;
  --blue-dark: #0051a8;
  --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
    Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
  --nav-height: 50px;
  --transition-speed: 0.3s;
  --border-radius: 16px;
  --menu-bg-light: #e6f0ff;
  --menu-bg-dark: #003366;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}
html,
body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: var(--font-stack);
  background: var(--gray-light);
  color: var(--gray-dark);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
  transition: background-color 0.3s, color 0.3s;
  user-select: none;
}
body.dark-mode {
  background: #121212;
  color: var(--gray-light);
}

a {
  color: var(--blue);
  text-decoration: none;
  cursor: pointer;
  transition: color var(--transition-speed);
  user-select: none;
}
a:hover,
a:focus {
  color: var(--blue-dark);
  outline: none;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--nav-height);
  background: var(--white);
  box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 16px;
  z-index: 1010;
  user-select: none;
  transition: background-color 0.3s, color 0.3s;
}
body.dark-mode header {
  background: #1c1c1e;
  box-shadow: 0 2px 6px #000a;
}
.logo-container {
  display: flex;
  align-items: center;
  color: var(--blue);
  font-weight: 700;
  font-size: 1.6rem;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  transition: color 0.3s;
}
body.dark-mode .logo-container {
  color: var(--gray-light);
}
.logo-container .material-symbols-outlined {
  font-size: 30px;
}
.logo-container:hover,
.logo-container:focus {
  color: var(--blue-dark);
  outline: none;
}

main {
  margin: calc(var(--nav-height) + 20px) 16px 90px 16px;
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 24px 20px 32px;
  min-height: calc(100vh - calc(var(--nav-height) + 170px));
  overflow-y: auto;
  user-select: text;
  transition: background-color 0.3s, color 0.3s;
}
body.dark-mode main {
  background: #222;
  color: var(--gray-light);
}

/* Notes section */
.note-section {
  margin-bottom: 40px;
}
.note-section h3 {
  margin-bottom: 16px;
  font-weight: 700;
  font-size: 1.8rem;
  color: var(--blue-dark);
  border-bottom: 3px solid var(--blue);
  padding-bottom: 6px;
  user-select: none;
}
body.dark-mode .note-section h3 {
  color: var(--blue);
  border-color: rgba(0, 85, 179, 0.9);
}
.section-notes-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.section-notes-list li {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border-radius: var(--border-radius);
  font-weight: 600;
  font-size: 1.25rem;
  color: var(--gray-dark);
  cursor: pointer;
  transition: background-color 0.3s;
  user-select: none;
  position: relative;
}
body.dark-mode .section-notes-list li {
  color: var(--gray-light);
}
.section-notes-list li:hover,
.section-notes-list li:focus-within {
  background: var(--menu-bg-light);
  outline: none;
}
body.dark-mode .section-notes-list li:hover,
body.dark-mode .section-notes-list li:focus-within {
  background: #333;
}
.section-notes-list li a {
  color: inherit;
  outline: none;
  display: block;
  flex-grow: 1;
  user-select:none;
  text-decoration:none;
}

/* Favorite heart */
.fav-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--gray-medium);
  font-size: 22px;
  margin-left: auto;
  user-select: none;
  transition: color 0.3s;
  display: flex;
  align-items: center;
}
.fav-btn.liked {
  color: crimson;
  animation: heart-pop 0.4s ease forwards;
}
@keyframes heart-pop {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.4);
  }
  100% {
    transform: scale(1);
  }
}

/* Letter box */
.letter-box {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  background: var(--blue);
  border-radius: 12px;
  color: var(--white);
  font-weight: 700;
  font-size: 1.2rem;
  user-select: none;
}
body.dark-mode .letter-box {
  background: var(--blue-dark);
}
.numbering {
  font-weight: 700;
  font-size: 1.1rem;
  width: 30px;
  display: flex;
  justify-content: center;
  user-select: none;
  color: var(--blue);
}
body.dark-mode .numbering {
  color: var(--blue);
}

/* Download page */
#download-page {
  display: none;
  text-align: center;
  user-select:none;
}
#download-page h2 {
  font-size: 2rem;
  font-weight: 800;
  color: var(--blue-dark);
  margin-bottom: 22px;
  user-select:none;
}
body.dark-mode #download-page h2 {
  color: var(--blue);
}
#download-page p {
  font-size: 1.1rem;
  color: var(--gray-dark);
  margin-bottom: 16px;
  user-select:none;
}
body.dark-mode #download-page p {
  color: var(--gray-light);
}
#progress-bar-container {
  position: relative;
  height: 6px;
  width: 100%;
  background: var(--gray-medium);
  border-radius: 6px;
  margin: 0 auto 8px auto;
  max-width: 400px;
}
#progress-bar {
  background: var(--blue);
  height: 6px;
  width: 0%;
  border-radius: 6px;
  transition: width 0.3s ease;
}
#progress-text {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-weight: 700;
  color: var(--gray-dark);
  user-select:none;
  font-size: 0.9rem;
}
#download-progress-info {
  margin-bottom: 8px;
  font-weight: 600;
  font-size: 1rem;
  color: var(--gray-medium);
  min-height: 1.3em;
}
body.dark-mode #download-progress-info {
  color: var(--gray-light);
}

/* Bottom navigation */
#bottom-nav-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--white);
  border-top: 1px solid #ccc;
  box-shadow: 0 -1px 4px rgba(0, 0, 0, 0.07);
  display: flex;
  align-items: center;
  height: var(--nav-height);
  padding: 0 12px;
  gap: 10px;
  user-select:none;
  z-index: 1100;
}
body.dark-mode #bottom-nav-container {
  background: #1c1c1e;
  border-color: #333;
  box-shadow: 0 -1px 6px #000a;
}
nav#site-nav {
  background: var(--menu-bg-light);
  border-radius: var(--border-radius);
  padding: 8px 12px;
  display: flex;
  gap: 12px;
  max-width: 100%;
  height: 44px;
  flex-shrink: 1;
  flex-grow: 1;
  overflow-x: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--blue) var(--gray-light);
}
nav#site-nav a {
  color: var(--blue);
  font-size: 1.1rem;
  line-height: 36px;
  height: 36px;
  white-space: nowrap;
  padding: 0 12px;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  cursor: pointer;
  font-weight: 600;
  text-transform: uppercase;
  gap: 4px;
  transition: background-color 0.3s, color 0.3s;
}
nav#site-nav a span.material-symbols-outlined {
  font-size: 22px;
}
nav#site-nav a.active,
nav#site-nav a:hover,
nav#site-nav a:focus {
  background-color: var(--blue);
  color: var(--white);
  outline: none;
}
body.dark-mode nav#site-nav a.active,
body.dark-mode nav#site-nav a:hover,
body.dark-mode nav#site-nav a:focus {
  background-color: var(--blue-dark);
  color: white;
}
#bottom-icons {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
#bottom-icons button.icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--blue);
  font-size: 26px;
  padding: 6px;
  border-radius: 10px;
  transition: background-color 0.3s, color 0.3s;
}
body.dark-mode #bottom-icons button.icon-btn {
  color: var(--gray-light);
}
#bottom-icons button.icon-btn:hover,
#bottom-icons button.icon-btn:focus {
  background-color: rgba(0, 122, 255, 0.25);
  color: var(--white);
  outline: none;
}
body.dark-mode #bottom-icons button.icon-btn:hover,
body.dark-mode #bottom-icons button.icon-btn:focus {
  background-color: rgba(0, 85, 179, 0.5);
  color: var(--white);
}
/* Icon mode */
body.icon-mode nav#site-nav a > span:last-child {
  display: none !important;
}
body.icon-mode nav#site-nav a {
  font-size: 0 !important;
  padding: 0 8px !important;
  justify-content: center;
}
/* Accessibility */
a:focus-visible,
button:focus-visible {
  outline: 2px solid var(--blue);
  outline-offset: 4px;
}
/* Responsive */
@media (max-width:720px) {
  main {
    margin: calc(var(--nav-height) + 20px) 12px 140px;
  }
  #bottom-nav-container {
    padding: 0 12px;
    gap:6px;
    justify-content: space-between;
    flex-wrap: nowrap;
  }
  nav#site-nav {
    padding: 6px 8px;
    height: 40px;
    margin-bottom: 0;
    justify-content: center;
    gap: 8px;
    max-width: calc(100% - 100px);
  }
  nav#site-nav a {
    font-size: 0;
    flex-direction: column;
    align-items: center;
    white-space: nowrap;
  }
  nav#site-nav a span.material-symbols-outlined {
    font-size: 24px;
    user-select:none;
  }
  nav#site-nav a > span:last-child {
    display: none;
  }
  #bottom-icons {
    position: fixed !important;
    bottom: 56px;
    right: 12px;
    background: rgba(255 255 255 / 0.85);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 8px 12px;
    gap: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    z-index: 1200;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    user-select:none;
    display: flex !important;
    flex-wrap: nowrap;
  }
  body.dark-mode #bottom-icons {
    background: rgba(28 28 30 / 0.85);
    box-shadow: 0 4px 10px rgba(0,0,0,0.6);
  }
  #bottom-icons.show {
    display: flex;
  }
  #bottom-icons button.icon-btn {
    font-size: 24px;
    padding: 6px;
  }
  #icons-toggle-btn {
    display: none; /* Hide old icon toggle */
  }
  /* New toggle button for menu */
  #menu-toggle-btn {
    display: block;
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--blue);
    font-size: 32px;
    padding: 6px 8px;
    border-radius: 14px;
    user-select: none;
    transition: background-color 0.3s, color 0.3s;
    flex-shrink: 0;
    align-self: center;
    z-index: 1210;
  }
}
@media (min-width: 721px) {
  #menu-toggle-btn {
    display: none;
  }
}
/* Profile modal */
#profile-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  width: 90%;
  max-width: 380px;
  z-index: 1300;
  padding: 20px;
  transition: transform 0.25s ease;
  user-select:none;
  display: none;
}
body.dark-mode #profile-modal {
  background: #222;
  color: var(--gray-light);
}
#profile-modal.show {
  display: block;
  transform: translate(-50%, -50%) scale(1);
}
#profile-modal header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
#profile-modal header h2 {
  margin: 0;
}
#profile-modal button.close-btn {
  background: transparent;
  border: none;
  font-size: 28px;
  line-height: 1;
  cursor: pointer;
  color: var(--blue);
}
#profile-modal button.close-btn:hover,
#profile-modal button.close-btn:focus {
  color: var(--blue-dark);
  outline: none;
}
#profile-modal .profile-info {
  margin-bottom: 16px;
}
#profile-modal .login-signup {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
#profile-modal .login-signup button {
  background: var(--blue);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 10px 16px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.3s;
}
#profile-modal .login-signup button:hover,
#profile-modal .login-signup button:focus {
  background: var(--blue-dark);
  outline: none;
}
</style>
</head>
<body>

<header>
  <div class="logo-container" tabindex="0" role="button" aria-label="Home" title="Home">
    <span class="material-symbols-outlined" aria-hidden="true">aodglyphsarchitecture</span>
  </div>
</header>

<main>
  <section id="content-page" aria-label="Notes Content"></section>

  <section id="download-page" aria-live="polite" aria-atomic="true" style="display:none; text-align:center; padding: 0 20px;">
    <h2 id="note-title"></h2>
    <p id="note-description"></p>
    <div id="progress-bar-container" aria-hidden="true">
      <div id="progress-bar"></div>
      <div id="progress-text" aria-live="off" aria-atomic="true">0%</div>
    </div>
    <div id="download-progress-info" style="margin-bottom: 8px;"></div>
    <div id="download-progress-bar"></div>

    <div id="download-actions">
      <button id="download-btn" disabled>Download PDF</button>
      <button id="back-btn">‚Üê Back to Notes</button>
    </div>
  </section>

  <section id="settings-page" role="region" aria-label="Settings Page" style="display:none;">
    <h2>Settings</h2>
    <div class="setting-option">
      <label for="dark-mode-toggle">
        <input type="checkbox" id="dark-mode-toggle" />
        Enable Dark Mode
      </label>
    </div>
    <div class="setting-option">
      <label for="icon-mode-toggle">
        <input type="checkbox" id="icon-mode-toggle" />
        Icon Mode (Icons Only in Navigation)
      </label>
    </div>
    <div class="setting-option">
      <label for="text-color-picker">
        Change Text Color
        <input type="color" id="text-color-picker" value="#232323" />
      </label>
    </div>
  </section>

  <section id="info-page" role="region" aria-label="Information Page" style="display:none;">
    <h2>About This App</h2>
    <div>
      <h3>Recent Activity</h3>
      <ul id="recent-activity"></ul>
    </div>
    <div>
      <h3>Downloads</h3>
      <ul id="downloads-list"></ul>
    </div>
    <div>
      <h3>Notifications</h3>
      <ul id="notifications-list"></ul>
    </div>
  </section>
</main>

<footer id="bottom-nav-container" aria-label="Bottom navigation and actions">
  <nav id="site-nav" role="navigation" aria-label="Site Navigation">
    <a href="#" id="nav-home" class="active" role="link" tabindex="0" aria-current="page">
      <span class="material-symbols-outlined" aria-hidden="true">home</span><span>Home</span>
    </a>
    <a href="#" id="nav-notes" role="link" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">note</span><span>Notes</span>
    </a>
    <a href="#" id="nav-download" role="link" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">download</span><span>Downloaded</span>
    </a>
    <a href="#" id="nav-settings" role="link" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">settings</span><span>Settings</span>
    </a>
    <a href="#" id="nav-info" role="link" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">info</span><span>Info</span>
    </a>
  </nav>
  <button id="menu-toggle-btn" aria-label="Toggle menu" title="Toggle menu" aria-expanded="false">
    <span class="material-symbols-outlined" aria-hidden="true">menu</span>
  </button>
  <div id="bottom-icons" aria-label="Bottom action icons">
    <button id="theme-toggle" class="icon-btn" aria-label="Toggle light/dark theme" title="Toggle theme" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">light_mode</span>
    </button>
    <button id="user-profile-btn" class="icon-btn" aria-label="User Profile" title="User Profile" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">person</span>
    </button>
    <button id="favorites-btn" class="icon-btn" aria-label="Favorites" title="Favorites" tabindex="0">
      <span class="material-symbols-outlined" aria-hidden="true">favorite</span>
    </button>
  </div>
</footer>

<div id="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title" tabindex="-1" style="display:none;">
  <header>
    <h2 id="profile-modal-title">User Profile</h2>
    <button class="close-btn" aria-label="Close profile modal">&times;</button>
  </header>
  <div class="profile-info" id="profile-info">
    <p>Viewing as <strong>Guest</strong></p>
  </div>
  <div class="login-signup">
    <button id="btn-login">Login</button>
    <button id="btn-signup">Sign Up</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let notesDataCache = null;
  let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  let downloadedNotes = JSON.parse(localStorage.getItem('downloadedNotes') || '[]');
  let recentActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
  let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
  let userProfile = JSON.parse(localStorage.getItem('userProfile') || '{"loggedIn":false,"username":null}');

  let downloadInterval = null;
  let ongoingDownloadNote = null;

  // Elements
  const contentPage = document.getElementById('content-page');
  const downloadPage = document.getElementById('download-page');
  const noteTitleElem = document.getElementById('note-title');
  const noteDescElem = document.getElementById('note-description');
  const downloadBtn = document.getElementById('download-btn');
  const backBtn = document.getElementById('back-btn');
  const progressBarContainer = document.getElementById('progress-bar-container');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const downloadProgressInfo = document.getElementById('download-progress-info');
  const downloadProgressBar = document.getElementById('download-progress-bar');

  const navHomeLink = document.getElementById('nav-home');
  const navNotesLink = document.getElementById('nav-notes');
  const navDownloadLink = document.getElementById('nav-download');
  const navSettingsLink = document.getElementById('nav-settings');
  const navInfoLink = document.getElementById('nav-info');
  const topNavLinks = [navHomeLink, navNotesLink, navDownloadLink, navSettingsLink, navInfoLink];

  const themeToggleBtn = document.getElementById('theme-toggle');
  const darkModeToggleCheckbox = document.getElementById('dark-mode-toggle');

  const iconModeToggleCheckbox = document.getElementById('icon-mode-toggle');
  const textColorPicker = document.getElementById('text-color-picker');

  const profileModal = document.getElementById('profile-modal');
  const profileInfo = document.getElementById('profile-info');
  const userProfileBtn = document.getElementById('user-profile-btn');
  const profileCloseBtn = document.querySelector('#profile-modal > header > button.close-btn');
  const btnLogin = document.getElementById('btn-login');
  const btnSignup = document.getElementById('btn-signup');

  const favoritesBtn = document.getElementById('favorites-btn');

  const recentActivityList = document.getElementById('recent-activity');
  const downloadsList = document.getElementById('downloads-list');
  const notificationsList = document.getElementById('notifications-list');

  // Utilities
  function saveFavorites() {
    localStorage.setItem('favorites', JSON.stringify(favorites));
  }
  function saveDownloadedNotes() {
    localStorage.setItem('downloadedNotes', JSON.stringify(downloadedNotes));
  }
  function saveUserProfile() {
    localStorage.setItem('userProfile', JSON.stringify(userProfile));
  }
  function saveRecentActivity() {
    localStorage.setItem('recentActivity', JSON.stringify(recentActivity));
  }
  function saveNotifications() {
    localStorage.setItem('notifications', JSON.stringify(notifications));
  }
  function addRecentActivity(text) {
    const time = new Date().toLocaleString();
    recentActivity.unshift(`${time} - ${text}`);
    if (recentActivity.length > 20) recentActivity.pop();
    saveRecentActivity();
  }
  function addNotification(text) {
    const time = new Date().toLocaleString();
    notifications.unshift(`${time} - ${text}`);
    if (notifications.length > 20) notifications.pop();
    saveNotifications();
  }

  // Create element helpers
  function createLetterBox(text) {
    const box = document.createElement('div');
    box.className = 'letter-box';
    box.textContent = text.toUpperCase();
    return box;
  }
  function createNumbering(num) {
    const div = document.createElement('div');
    div.className = 'numbering';
    div.textContent = num + '.';
    return div;
  }
  function createFavButton(noteId) {
    const btn = document.createElement('button');
    btn.className = 'fav-btn';
    btn.type = 'button';
    const liked = favorites.includes(noteId);
    btn.setAttribute('aria-label', liked ? 'Remove from favorites' : 'Add to favorites');
    btn.title = btn.getAttribute('aria-label');
    btn.innerHTML = `<span class="material-symbols-outlined" aria-hidden="true">${liked ? 'favorite' : 'favorite_border'}</span>`;
    if (liked) btn.classList.add('liked');
    btn.onclick = e => {
      e.stopPropagation();
      toggleFavorite(noteId, btn);
    };
    return btn;
  }
  function toggleFavorite(noteId, btn) {
    const idx = favorites.indexOf(noteId);
    if (idx === -1) {
      favorites.push(noteId);
      btn.classList.add('liked');
      btn.setAttribute('aria-label', 'Remove from favorites');
      btn.title = 'Remove from favorites';
      btn.innerHTML = '<span class="material-symbols-outlined" aria-hidden="true">favorite</span>';
      addRecentActivity(`Added "${getNoteById(noteId).title}" to favorites.`);
    } else {
      favorites.splice(idx, 1);
      btn.classList.remove('liked');
      btn.setAttribute('aria-label', 'Add to favorites');
      btn.title = 'Add to favorites';
      btn.innerHTML = '<span class="material-symbols-outlined" aria-hidden="true">favorite_border</span>';
      addRecentActivity(`Removed "${getNoteById(noteId).title}" from favorites.`);
    }
    saveFavorites();
  }

  function getNoteById(id) {
    for (const section of notesDataCache.sections) {
      for (const note of section.notes) {
        if(note.id === id) return note;
      }
    }
    return null;
  }

  // Hide all content sections
  function hideAllPages() {
    contentPage.style.display = 'none';
    downloadPage.style.display = 'none';
    document.getElementById('settings-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'none';
  }

  // Update active nav tab styling
  function setActiveTopTab(activeLink) {
    topNavLinks.forEach(link => {
      if(link === activeLink) {
        link.classList.add('active');
        link.setAttribute('aria-current', 'page');
      } else {
        link.classList.remove('active');
        link.removeAttribute('aria-current');
      }
    });
  }

  // Render sections list
  function renderSectionsList() {
    hideAllPages();
    contentPage.innerHTML = '';
    const ul = document.createElement('ul');
    ul.className = 'section-notes-list';
    notesDataCache.sections.forEach((section, idx) => {
      const li = document.createElement('li');
      li.tabIndex = 0;
      li.role = 'button';
      li.appendChild(createNumbering(idx+1));
      li.appendChild(createLetterBox(section.name.slice(0, 2)));
      const span = document.createElement('span');
      span.textContent = section.name;
      span.style.flexGrow = '1';
      li.appendChild(span);
      li.onclick = () => {
        renderNotesList(section);
        setActiveTopTab(navNotesLink);
      };
      li.onkeydown = e => {
        if (e.key==='Enter'||e.key===' ') {
          e.preventDefault();
          li.click();
        }
      };
      ul.appendChild(li);
    });
    contentPage.appendChild(ul);
    contentPage.style.display = '';
  }

  // Render notes list of a section
  function renderNotesList(section) {
    hideAllPages();
    contentPage.innerHTML = '';
    const secEl = document.createElement('section');
    secEl.className = 'note-section';
    const h3 = document.createElement('h3');
    h3.textContent = section.name;
    secEl.appendChild(h3);
    const ul = document.createElement('ul');
    ul.className = 'section-notes-list';
    section.notes.forEach((note, idx) => {
      const li = document.createElement('li');
      li.tabIndex = 0;
      li.role = 'button';
      li.appendChild(createNumbering(idx+1));
      li.appendChild(createLetterBox(note.title.slice(0, 2)));
      const a = document.createElement('a');
      a.href = '#';
      a.textContent = note.title;
      a.tabIndex = -1;
      li.appendChild(a);
      const favBtn = createFavButton(note.id);
      li.appendChild(favBtn);
      li.onclick = () => openDownloadPage(note);
      li.onkeydown = e => {
        if (e.key==='Enter'||e.key===' ') {
          e.preventDefault();
          li.click();
        }
      };
      ul.appendChild(li);
    });
    secEl.appendChild(ul);
    contentPage.appendChild(secEl);
    contentPage.style.display = '';
  }

  // Open download page
  function openDownloadPage(note) {
    hideAllPages();
    downloadPage.style.display = 'block';
    noteTitleElem.textContent = note.title;
    noteDescElem.textContent = note.description || 'Tap the button below to download the note.';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    downloadProgressBar.style.width = '0%';
    downloadProgressInfo.textContent = '';
    downloadBtn.disabled = !note.pdfLink || note.pdfLink === '#';
    if(downloadBtn._listener) downloadBtn.removeEventListener('click', downloadBtn._listener);
    downloadBtn._listener = () => startDownloadAnimation(note);
    downloadBtn.addEventListener('click', downloadBtn._listener);
  }

  // Download animation simulation
  function startDownloadAnimation(note) {
    if(downloadInterval) clearInterval(downloadInterval);

    let downloaded = 0;
    const totalSize = 10 * 1024 * 1024;
    const startTime = performance.now();

    downloadBtn.disabled = true;
    downloadProgressInfo.textContent = 'Starting download...';
    progressBarContainer.style.display = 'block';
    ongoingDownloadNote = note;
    addRecentActivity(`Started downloading: ${note.title}`);

    downloadInterval = setInterval(() => {
      const now = performance.now();
      const elapsed = Math.max((now - startTime) / 1000, 0.001);
      const chunk = (Math.random() * 200 + 100) * 1024 / 4;
      downloaded += chunk;
      if(downloaded > totalSize) downloaded = totalSize;

      const percent = (downloaded / totalSize) * 100;
      progressBar.style.width = percent + '%';
      progressText.textContent = Math.floor(percent) + '%';
      downloadProgressBar.style.width = percent + '%';

      const speedKB = (downloaded / elapsed / 1024).toFixed(1);
      const remTime = (totalSize - downloaded) / (downloaded / elapsed);
      const mins = Math.floor(remTime / 60);
      const secs = Math.floor(remTime % 60);
      downloadProgressInfo.textContent = `Speed: ${speedKB} KB/s | Time Left: ${mins > 0 ? mins + 'm ' : ''}${secs}s`;

      if (percent >= 100) {
        clearInterval(downloadInterval);
        downloadInterval = null;
        addRecentActivity(`Completed downloading: ${note.title}`);
        downloadedNotes.push(note);
        localStorage.setItem('downloadedNotes', JSON.stringify(downloadedNotes));
        ongoingDownloadNote = null;
        downloadBtn.textContent = 'Download Complete';
        downloadBtn.disabled = false;

        setTimeout(() => {
          if(note.pdfLink && note.pdfLink !== '#') window.open(note.pdfLink, '_blank');
          backBtn.click();
          downloadBtn.textContent = 'Download PDF';
          progressBar.style.width = '0%';
          progressText.textContent = '0%';
          downloadProgressBar.style.width = '0%';
          downloadProgressInfo.textContent = '';
        }, 1300);
      }
    }, 300);
  }

  // Back button resets download page
  backBtn.onclick = e => {
    e.preventDefault();
    if(downloadInterval) {
      clearInterval(downloadInterval);
      downloadInterval = null;
    }
    downloadPage.style.display = 'none';
    contentPage.style.display = '';
    renderSectionsList();
  };

  // Render favorites list
  function showFavorites() {
    hideAllPages();
    setActiveTopTab(null);
    contentPage.innerHTML = '';
    const section = document.createElement('section');
    section.className = 'note-section';
    const h3 = document.createElement('h3');
    h3.textContent = 'Favorite Notes';
    section.appendChild(h3);
    const ul = document.createElement('ul');
    ul.className = 'section-notes-list';

    let count = 0;
    notesDataCache.sections.forEach(sec=>{
      sec.notes.forEach(note=>{
        if(favorites.includes(note.id)) {
          count++;
          const li = document.createElement('li');
          li.tabIndex = 0;
          li.role = 'button';
          li.appendChild(createNumbering(count));
          li.appendChild(createLetterBox(note.title.slice(0,2)));
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = note.title;
          a.tabIndex = -1;
          li.appendChild(a);
          const favBtn = createFavButton(note.id, true);
          li.appendChild(favBtn);
          li.onclick = () => openDownloadPage(note);
          li.onkeydown = e => {
            if(e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              li.click();
            }
          };
          ul.appendChild(li);
        }
      });
    });
    if(count === 0) {
      const li = document.createElement('li');
      li.textContent = 'No favorite notes yet.';
      ul.appendChild(li);
    }
    section.appendChild(ul);
    contentPage.appendChild(section);
    contentPage.style.display = '';
  }

  // Show download history page
  function showDownloadHistory() {
    hideAllPages();
    setActiveTopTab(navDownloadLink);

    contentPage.innerHTML = '';
    const section = document.createElement('section');
    section.className = 'note-section';
    const h3 = document.createElement('h3');
    h3.textContent = 'Downloaded Notes';
    section.appendChild(h3);
    const ul = document.createElement('ul');
    ul.className = 'section-notes-list';

    if(downloadedNotes.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No downloads yet.';
      ul.appendChild(li);
    } else {
      downloadedNotes.forEach((note, idx) => {
        const li = document.createElement('li');
        li.tabIndex = 0;
        li.role = 'button';
        li.appendChild(createNumbering(idx + 1));
        li.appendChild(createLetterBox(note.title.slice(0, 2)));
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = note.title;
        a.tabIndex = -1;
        li.appendChild(a);
        const favBtn = createFavButton(note.id, favorites.includes(note.id));
        li.appendChild(favBtn);
        li.onclick = () => openDownloadPage(note);
        li.onkeydown = e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            li.click();
          }
        };
        ul.appendChild(li);
      });
    }
    section.appendChild(ul);

    if(ongoingDownloadNote) {
      const ongoing = document.createElement('div');
      ongoing.style.marginTop = '20px';
      ongoing.innerHTML = `<strong>Ongoing Download:</strong> ${ongoingDownloadNote.title}`;
      section.appendChild(ongoing);
    }

    contentPage.appendChild(section);
    contentPage.style.display = '';
  }

  // Info page update lists
  function updateInfoPage() {
    const recentList = document.getElementById('recent-activity');
    const downloadsListElem = document.getElementById('downloads-list');
    const notificationsListElem = document.getElementById('notifications-list');
    recentList.innerHTML = '';
    downloadsListElem.innerHTML = '';
    notificationsListElem.innerHTML = '';

    if(recentActivity.length === 0) recentList.innerHTML = '<li>No recent activity.</li>';
    else recentActivity.forEach(act => {
      const li = document.createElement('li');
      li.textContent = act;
      recentList.appendChild(li);
    });
    if(downloadedNotes.length === 0) downloadsListElem.innerHTML = '<li>No downloads yet.</li>';
    else downloadedNotes.forEach(note => {
      const li = document.createElement('li');
      li.textContent = note.title;
      downloadsListElem.appendChild(li);
    });
    if(notifications.length === 0) notificationsListElem.innerHTML = '<li>No notifications.</li>';
    else notifications.forEach(notif => {
      const li = document.createElement('li');
      li.textContent = notif;
      notificationsListElem.appendChild(li);
    });
  }

  // Event handlers for nav
  navHomeLink.onclick = e => { e.preventDefault(); setActiveTopTab(navHomeLink); renderSectionsList(); };
  navNotesLink.onclick = e => { e.preventDefault(); setActiveTopTab(navNotesLink); if(notesDataCache.sections.length>0) renderNotesList(notesDataCache.sections[0]); };
  navDownloadLink.onclick = e => { e.preventDefault(); showDownloadHistory(); };
  navSettingsLink.onclick = e => { e.preventDefault(); setActiveTopTab(navSettingsLink); hideAllPages(); document.getElementById('settings-page').style.display = 'block'; };
  navInfoLink.onclick = e => { e.preventDefault(); setActiveTopTab(navInfoLink); hideAllPages(); document.getElementById('info-page').style.display = 'block'; updateInfoPage(); };

  // Theme toggles
  themeToggleBtn.onclick = () => {
    const darkOn = !document.body.classList.contains('dark-mode');
    if(darkOn) {
      document.body.classList.add('dark-mode');
      themeToggleBtn.innerHTML = '<span class="material-symbols-outlined">dark_mode</span>';
      darkModeToggleCheckbox.checked = true;
      localStorage.setItem('theme', 'dark');
    } else {
      document.body.classList.remove('dark-mode');
      themeToggleBtn.innerHTML = '<span class="material-symbols-outlined">light_mode</span>';
      darkModeToggleCheckbox.checked = false;
      localStorage.setItem('theme', 'light');
    }
  };
  darkModeToggleCheckbox.onchange = e => themeToggleBtn.click();

  // Icon mode toggle
  iconModeToggleCheckbox.onchange = e => {
    if(e.target.checked) document.body.classList.add('icon-mode');
    else document.body.classList.remove('icon-mode');
    localStorage.setItem('iconMode', e.target.checked);
  };

  // Text color picker
  textColorPicker.oninput = e => {
    document.documentElement.style.setProperty('--gray-dark', e.target.value);
    localStorage.setItem('textColor', e.target.value);
  };

  // User profile modal
  userProfileBtn.onclick = () => {
    updateProfileModal();
    profileModal.style.display = 'block';
    profileModal.classList.add('show');
    profileModal.focus();
  };
  profileCloseBtn.onclick = () => {
    profileModal.classList.remove('show');
    setTimeout(() => { profileModal.style.display = 'none'; }, 250);
  };
  btnLogin.onclick = () => {
    const u = prompt('Enter username to login:');
    if(u && u.trim()) {
      userProfile = {loggedIn:true, username:u.trim()};
      localStorage.setItem('userProfile', JSON.stringify(userProfile));
      updateProfileModal();
      setTimeout(() => { profileModal.classList.remove('show'); profileModal.style.display = 'none'; }, 250);
    }
  };
  btnSignup.onclick = () => {
    const u = prompt('Enter username to sign up:');
    if(u && u.trim()) {
      userProfile = {loggedIn:true, username:u.trim()};
      localStorage.setItem('userProfile', JSON.stringify(userProfile));
      updateProfileModal();
      setTimeout(() => { profileModal.classList.remove('show'); profileModal.style.display = 'none'; }, 250);
    }
  };
  function updateProfileModal(){
    if(userProfile.loggedIn){
      profileInfo.innerHTML = `<p>Logged in as <strong>${userProfile.username}</strong></p><button id="logout-btn">Logout</button>`;
      btnLogin.style.display = 'none';
      btnSignup.style.display = 'none';
      document.getElementById('logout-btn').onclick = () => {
        userProfile = {loggedIn:false, username:null};
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        updateProfileModal();
      };
    } else {
      profileInfo.innerHTML = '<p>Viewing as <strong>Guest</strong></p>';
      btnLogin.style.display = 'inline-block';
      btnSignup.style.display = 'inline-block';
    }
  }

  // Store and load theme, icon, and text color preferences
  function loadPreferences(){
    if(localStorage.getItem('theme') === 'dark'){
      document.body.classList.add('dark-mode');
      themeToggleBtn.innerHTML = '<span class="material-symbols-outlined">dark_mode</span>';
      darkModeToggleCheckbox.checked = true;
    }
    if(localStorage.getItem('iconMode') === 'true'){
      document.body.classList.add('icon-mode');
      iconModeToggleCheckbox.checked = true;
    }
    const textColor = localStorage.getItem('textColor');
    if(textColor){
      document.documentElement.style.setProperty('--gray-dark', textColor);
      textColorPicker.value = textColor;
    }
  }

  // Toggle bottom icons menu visibility on mobile
  const menuToggleBtn = document.getElementById('menu-toggle-btn');
  const bottomIconsContainer = document.getElementById('bottom-icons');

  menuToggleBtn.addEventListener('click', () => {
    if (bottomIconsContainer.style.display === 'flex') {
      bottomIconsContainer.style.display = 'none';
      menuToggleBtn.setAttribute('aria-expanded', 'false');
    } else {
      bottomIconsContainer.style.display = 'flex';
      menuToggleBtn.setAttribute('aria-expanded', 'true');
    }
  });

  // Initial render and preferences loading
  (async () => {
    try {
      const resp = await fetch('notes.json');
      if(!resp.ok) throw new Error('Failed to load notes.json');
      notesDataCache = await resp.json();
      renderSectionsList();
      setActiveTopTab(navHomeLink);
      loadPreferences();
      updateProfileModal();
    } catch(e) {
      contentPage.innerHTML = `<p style="color:red;">Failed to load notes.json: ${e.message}</p>`;
    }
  })();

});
</script>

</body>
</html>

